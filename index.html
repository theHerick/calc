<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner BLE LocSound1</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 28px;
    }

    button {
      padding: 15px 20px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 350px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #scanBtn {
      background-color: #4CAF50;
      color: white;
    }

    #scanBtn:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }

    .device-btn {
      background-color: #2196F3;
      color: white;
    }

    .device-btn:hover {
      background-color: #1976D2;
      transform: translateY(-2px);
    }

    .reconnect-btn {
      background-color: #ff9800;
      color: white;
    }

    .reconnect-btn:hover {
      background-color: #e68900;
      transform: translateY(-2px);
    }

    #status {
      margin: 20px 0;
      font-size: 18px;
      color: #444;
      font-weight: bold;
      max-width: 90%;
      word-wrap: break-word;
    }

    #deviceContainer {
      margin-top: 20px
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .device-item {
      background: white;
      border-radius: 8px;
      padding: 10px;
      width: 100%;
      max-width: 350px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    @media (max-width: 600px) {
      button {
        font-size: 16px;
        padding: 12px 15px;
      }
      h2 {
        font-size: 24px;
      }
      #status {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <h2>Scanner BLE - LocSound</h2>
  <button id="scanBtn">üîç Scanear Dispositivos LocSound</button>
  <div id="status">Clique em "Scanear Dispositivos" para come√ßar.</div>
  <div id="deviceContainer"></div>

  <script>
    const scanBtn = document.getElementById('scanBtn');
    const status = document.getElementById('status');
    const deviceContainer = document.getElementById('deviceContainer');
    const dispositivos = new Map(); // nome => device
    let voz = window.speechSynthesis;
    let scanAtivo = null;

    function falar(texto) {
      const msg = new SpeechSynthesisUtterance(texto);
      msg.lang = 'pt-BR';
      msg.rate = 1.1;
      msg.pitch = 1;
      voz.cancel();
      voz.speak(msg);
    }

    function ordenarDispositivos() {
      return Array.from(dispositivos.entries()).sort((a, b) => {
        const aIsLocSound = a[0].startsWith('LocSound');
        const bIsLocSound = b[0].startsWith('LocSound');
        if (aIsLocSound && !bIsLocSound) return -1;
        if (!aIsLocSound && bIsLocSound) return 1;
        return a[0].localeCompare(b[0]);
      });
    }

    function atualizarListaDispositivos() {
      deviceContainer.innerHTML = '';
      const dispositivosOrdenados = ordenarDispositivos();
      for (const [nome, device] of dispositivosOrdenados) {
        const item = criarBotaoDispositivo(nome, device);
        deviceContainer.appendChild(item);
      }
      status.textContent = dispositivos.size > 0
        ? `üì° ${dispositivos.size} dispositivo(s) encontrado(s)`
        : '‚ö†Ô∏è Nenhum dispositivo encontrado';
      if (dispositivos.size > 0) {
        falar(`${dispositivos.size} dispositivo${dispositivos.size > 1 ? 's' : ''} encontrado${dispositivos.size > 1 ? 's' : ''}`);
      }
    }

    function criarBotaoDispositivo(nome, device) {
      const deviceItem = document.createElement('div');
      deviceItem.className = 'device-item';

      const btn = document.createElement('button');
      btn.className = 'device-btn';
      btn.textContent = `LocSound - ${nome}`;

      const btnReconnect = document.createElement('button');
      btnReconnect.className = 'reconnect-btn';
      btnReconnect.textContent = `üîÑ Reconectar - ${nome}`;

      let pressTimer;
      let conectado = false;
      let server = null;

      btn.addEventListener('click', () => {
        falar(`Dispositivo ${nome}`);
      });

      btn.addEventListener('mousedown', () => {
        pressTimer = setTimeout(async () => {
          try {
            status.textContent = `üîå Conectando a ${nome}...`;
            falar(`Conectando a ${nome}`);
            server = await device.gatt.connect();
            conectado = true;
            status.textContent = `‚úÖ Conectado a ${nome}`;
            falar(`Conectado a ${nome}`);
            btn.style.backgroundColor = '#4CAF50';
          } catch (error) {
            status.textContent = `‚ùå Erro ao conectar a ${nome}: ${error.message}`;
            falar(`Erro ao conectar em ${nome}`);
          }
        }, 800);
      });

      btn.addEventListener('mouseup', () => clearTimeout(pressTimer));
      btn.addEventListener('mouseleave', () => clearTimeout(pressTimer));

      btnReconnect.addEventListener('click', async () => {
        try {
          status.textContent = `üîÅ Reconectando a ${nome}...`;
          falar(`Reconectando a ${nome}`);
          if (device.gatt.connected) {
            device.gatt.disconnect();
          }
          server = await device.gatt.connect();
          conectado = true;
          status.textContent = `‚úÖ Reconectado a ${nome}`;
          falar(`Reconectado a ${nome}`);
          btn.style.backgroundColor = '#4CAF50';
        } catch (error) {
          status.textContent = `‚ùå Falha ao reconectar: ${error.message}`;
          falar(`Erro ao reconectar em ${nome}`);
        }
      });

      deviceItem.appendChild(btn);
      deviceItem.appendChild(btnReconnect);
      return deviceItem;
    }

    scanBtn.addEventListener('click', async () => {
      if (!navigator.bluetooth || !navigator.bluetooth.requestLEScan) {
        status.textContent = "‚ùå Seu navegador n√£o suporta Web Bluetooth ou escaneamento autom√°tico.";
        falar("Navegador n√£o suporta escaneamento Bluetooth.");
        return;
      }

      try {
        status.textContent = "üîç Escaneando dispositivos...";
        falar("Escaneando dispositivos");
        
        // Para qualquer escaneamento anterior
        if (scanAtivo) {
          scanAtivo.stop();
        }

        // Inicia o escaneamento
        scanAtivo = await navigator.bluetooth.requestLEScan({
          filters: [{ namePrefix: 'LocSound' }],
          keepAll: true
        });

        // Escuta eventos de dispositivos encontrados
        navigator.bluetooth.addEventListener('advertisementreceived', (event) => {
          const device = event.device;
          if (device.name && !dispositivos.has(device.name)) {
            dispositivos.set(device.name, device);
            atualizarListaDispositivos();
          }
        });

        // Para o escaneamento ap√≥s 10 segundos
        setTimeout(() => {
          if (scanAtivo) {
            scanAtivo.stop();
            scanAtivo = null;
            status.textContent = dispositivos.size > 0
              ? `üì° Escaneamento conclu√≠do: ${dispositivos.size} dispositivo(s) encontrado(s)`
              : '‚ö†Ô∏è Nenhum dispositivo encontrado';
            falar("Escaneamento conclu√≠do");
          }
        }, 10000);

      } catch (error) {
        status.textContent = `‚ùå Erro ao iniciar escaneamento: ${error.message}`;
        falar(`Erro: ${error.message}`);
        scanAtivo = null;
      }
    });
  </script>
</body>
</html>
