<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>LocSound BLE1</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #f0f0f0;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    .device-btn {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 260px;
      border: none;
      border-radius: 6px;
    }
    .online { background: #4CAF50; color: white; }
    .offline { background: #f44336; color: white; }
    #deviceContainer { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>LocSound BLE</h2>

  <div id="loginDiv">
    <input type="text" id="nome" placeholder="Nome"><br>
    <input type="password" id="senha" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
  </div>

  <div id="appDiv" style="display:none">
    <h3 id="userTitle"></h3>
    <button onclick="scanBLE()">üîç Procurar Dispositivos</button>
    <button onclick="desconectarTodos()">‚õî Desconectar de Todos</button>
    <div id="deviceContainer"></div>
  </div>

  <script>
    let usuarioAtual = null;

    function login() {
      const nome = document.getElementById("nome").value.trim();
      const senha = document.getElementById("senha").value;

      if (!nome || !senha) return alert("Preencha nome e senha");

      let users = JSON.parse(localStorage.getItem("usuarios") || "{}");

      if (!users[nome]) {
        users[nome] = { senha, dispositivos: {} };
        localStorage.setItem("usuarios", JSON.stringify(users));
        alert("Conta criada com sucesso!");
      } else if (users[nome].senha !== senha) {
        return alert("Senha incorreta");
      }

      usuarioAtual = nome;
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("appDiv").style.display = "block";
      document.getElementById("userTitle").innerText = `Usu√°rio: ${nome}`;
      renderizarDispositivos();
    }

    function renderizarDispositivos() {
      const users = JSON.parse(localStorage.getItem("usuarios"));
      const dispositivos = users[usuarioAtual].dispositivos;
      const container = document.getElementById("deviceContainer");
      container.innerHTML = "";

      for (let nome in dispositivos) {
        const info = dispositivos[nome];
        const btn = document.createElement("button");
        btn.className = `device-btn ${info.online ? "online" : "offline"}`;
        btn.innerText = `${nome} - ${info.online ? "Online" : "Offline"}`;
        if (!info.online) {
          btn.onclick = () => conectarDispositivo(nome);
        }
        container.appendChild(btn);
      }
    }

    async function scanBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true
        });

        salvarDispositivo(device.name || device.id);
      } catch (e) {
        alert("Erro ao escanear: " + e);
      }
    }

    function salvarDispositivo(nome) {
      const users = JSON.parse(localStorage.getItem("usuarios"));
      const user = users[usuarioAtual];

      user.dispositivos[nome] = {
        online: true,
        ultimoUso: new Date().toISOString()
      };
      localStorage.setItem("usuarios", JSON.stringify(users));
      renderizarDispositivos();
    }

    function conectarDispositivo(nome) {
      const users = JSON.parse(localStorage.getItem("usuarios"));
      const user = users[usuarioAtual];

      user.dispositivos[nome].online = true;
      user.dispositivos[nome].ultimoUso = new Date().toISOString();
      localStorage.setItem("usuarios", JSON.stringify(users));
      renderizarDispositivos();
    }

    function desconectarTodos() {
      const users = JSON.parse(localStorage.getItem("usuarios"));
      const user = users[usuarioAtual];

      for (let nome in user.dispositivos) {
        user.dispositivos[nome].online = false;
      }
      localStorage.setItem("usuarios", JSON.stringify(users));
      renderizarDispositivos();
    }
  </script>
</body>
</html>
