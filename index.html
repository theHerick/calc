<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scanner BLE LocSound</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 28px;
    }
    button {
      padding: 15px 20px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 350px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #scanBtn {
      background-color: #4CAF50;
      color: white;
    }
    #scanBtn:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }
    .device-btn {
      background-color: #2196F3;
      color: white;
    }
    .device-btn:hover {
      background-color: #1976D2;
      transform: translateY(-2px);
    }
    #status {
      margin: 20px 0;
      font-size: 18px;
      color: #444;
      font-weight: bold;
      max-width: 90%;
      word-wrap: break-word;
    }
    #deviceContainer {
      margin-top: 20px;
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .device-item {
      background: white;
      border-radius: 8px;
      padding: 10px;
      width: 100%;
      max-width: 350px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>Scanner BLE - LocSound</h2>
  <button id="scanBtn">üîç Scanear Dispositivos LocSound</button>
  <div id="status">Clique em "Scanear Dispositivos" para come√ßar.</div>
  <div id="deviceContainer"></div>

  <script>
    const scanBtn = document.getElementById('scanBtn');
    const status = document.getElementById('status');
    const deviceContainer = document.getElementById('deviceContainer');
    const storageKey = 'dispositivosLocSoundSalvos';

    // Map: nome => objeto real BluetoothDevice ou objeto parcial {name, id}
    const dispositivos = new Map();
    let voz = window.speechSynthesis;

    function falar(texto) {
      const msg = new SpeechSynthesisUtterance(texto);
      msg.lang = 'pt-BR';
      msg.rate = 1.1;
      msg.pitch = 1;
      voz.cancel();
      voz.speak(msg);
    }

    function salvarDispositivosLocalmente() {
      // Salva s√≥ nome e id (se existir)
      const dados = Array.from(dispositivos.values()).map(d => ({
        name: d.name,
        id: d.id || null
      }));
      localStorage.setItem(storageKey, JSON.stringify(dados));
    }

    function carregarDispositivosSalvos() {
      const salvos = JSON.parse(localStorage.getItem(storageKey)) || [];
      salvos.forEach(d => {
        dispositivos.set(d.name, d);
      });
      atualizarListaDispositivos();
    }

    function ordenarDispositivos(devices) {
      return devices.sort((a, b) => {
        const aIsLocSound = a.name && a.name.startsWith('LocSound');
        const bIsLocSound = b.name && b.name.startsWith('LocSound');
        if (aIsLocSound && !bIsLocSound) return -1;
        if (!aIsLocSound && bIsLocSound) return 1;
        return a.name.localeCompare(b.name);
      });
    }

    scanBtn.addEventListener('click', async () => {
      if (!navigator.bluetooth) {
        status.textContent = "‚ùå Seu navegador n√£o suporta Web Bluetooth.";
        falar("Navegador n√£o suporta Bluetooth.");
        return;
      }

      try {
        status.textContent = "üîç Escaneando dispositivos...";
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'LocSound' }],
          optionalServices: ['battery_service', 'device_information']
        });

        if (!device.name) {
          status.textContent = "‚ö†Ô∏è Dispositivo sem nome ignorado.";
          falar("Dispositivo sem nome ignorado.");
          return;
        }

        if (!dispositivos.has(device.name)) {
          dispositivos.set(device.name, device);
          salvarDispositivosLocalmente();
          atualizarListaDispositivos();
          status.textContent = `üì° Dispositivo adicionado: ${device.name}`;
          falar(`Dispositivo ${device.name} adicionado`);
        } else {
          status.textContent = `‚ÑπÔ∏è Dispositivo ${device.name} j√° est√° listado.`;
          falar(`Dispositivo ${device.name} j√° listado`);
        }
      } catch (error) {
        status.textContent = `‚ùå Erro: ${error.message}`;
        falar(`Erro: ${error.message}`);
      }
    });

    async function conectarDispositivo(device) {
      try {
        status.textContent = `üîå Conectando a ${device.name}...`;
        falar(`Conectando a ${device.name}`);

        // Se o device for um objeto real (tem gatt e connect)
        if (device.gatt && device.gatt.connect) {
          await device.gatt.connect();
          status.textContent = `‚úÖ Conectado a ${device.name}`;
          falar(`Conectado a ${device.name}`);
          return device; // Retorna o dispositivo real conectado
        }

        // Se for objeto parcial, tenta pedir de novo pelo nome
        const deviceReal = await navigator.bluetooth.requestDevice({
          filters: [{ name: device.name }],
          optionalServices: ['battery_service', 'device_information']
        });

        await deviceReal.gatt.connect();
        status.textContent = `‚úÖ Conectado a ${deviceReal.name}`;
        falar(`Conectado a ${deviceReal.name}`);

        // Atualiza na lista
        dispositivos.set(deviceReal.name, deviceReal);
        salvarDispositivosLocalmente();
        atualizarListaDispositivos();

        return deviceReal;

      } catch (error) {
        status.textContent = `‚ùå Erro ao conectar a ${device.name}: ${error.message}`;
        falar(`Erro ao conectar em ${device.name}`);
        throw error;
      }
    }

    function criarBotaoDispositivo(nome, device) {
      const deviceItem = document.createElement('div');
      deviceItem.className = 'device-item';

      const btn = document.createElement('button');
      btn.className = 'device-btn';
      btn.textContent = `LocSound - ${nome}`;

      btn.addEventListener('click', async () => {
        try {
          await conectarDispositivo(device);
        } catch {
          // Erro j√° tratado dentro conectarDispositivo
        }
      });

      deviceItem.appendChild(btn);
      return deviceItem;
    }

    function atualizarListaDispositivos() {
      deviceContainer.innerHTML = '';
      const dispositivosOrdenados = ordenarDispositivos(Array.from(dispositivos.values()));

      for (const device of dispositivosOrdenados) {
        const item = criarBotaoDispositivo(device.name, device);
        deviceContainer.appendChild(item);
      }
    }

    window.addEventListener('load', () => {
      carregarDispositivosSalvos();
    });
  </script>
</body>
</html>
