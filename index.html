<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora Solar para Carro El√©trico</title>
<style>
  :root{
    --bg: #0b1020;
    --card: rgba(255,255,255,0.06);
    --glass: rgba(255,255,255,0.08);
    --text: #ecf0ff;
    --muted: #c7cbee;
    --accent: #7ccfff;
    --accent-2: #a18cff;
    --ok: #7dffa7;
    --warn: #ffd37d;
    --err: #ff8f8f;
    --shadow: 0 10px 30px rgba(0,0,0,0.45);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 20% -10%, #2a3baa 0%, transparent 60%),
      radial-gradient(1000px 700px at 120% 10%, #26a3c8 0%, transparent 55%),
      radial-gradient(900px 600px at 50% 120%, #8e46ff 0%, transparent 45%),
      var(--bg);
    background-attachment: fixed;
  }
  header{
    padding: 28px 20px 8px;
    text-align:center;
  }
  h1{
    margin:0;
    font-size: clamp(28px, 4vw, 40px);
    letter-spacing: .4px;
  }
  .subtitle{
    margin-top:8px;
    color:var(--muted);
    font-size: clamp(14px, 2.2vw, 16px);
  }

  .container{
    width:min(1100px, 92vw);
    margin: 28px auto 80px;
    display:grid;
    grid-template-columns: 1.1fr 1fr;
    gap: 18px;
  }
  @media (max-width: 980px){
    .container{grid-template-columns:1fr}
  }

  .panel, .results{
    background: linear-gradient(180deg, var(--glass), transparent 140%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 18px;
  }

  .section-title{
    font-size: 16px;
    letter-spacing: .3px;
    margin: 8px 4px 12px;
    color: var(--accent);
    display:flex;
    align-items:center;
    gap:8px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width:680px){ .grid{grid-template-columns:1fr} }

  .cards-dyn {
    display: flex;
    flex-direction: column;
    gap: 18px;
    margin-bottom: 8px;
  }
  .card-dyn {
    background: var(--card);
    border: 1.5px solid rgba(255,255,255,0.14);
    border-radius: 14px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.18);
    padding: 18px 16px 10px 16px;
    position: relative;
    transition: box-shadow .2s;
  }
  .card-dyn:hover {
    box-shadow: 0 8px 32px rgba(124,207,255,0.12);
    border-color: var(--accent);
  }
  .card-dyn .card-title {
    font-size: 15px;
    color: var(--accent);
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: .2px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-dyn .remove-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    color: var(--err);
    border: none;
    font-size: 15px;
    cursor: pointer;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 8px;
    transition: background .2s;
  }
  .card-dyn .remove-btn:hover {
    background: rgba(255,143,143,0.12);
  }

  label{
    font-size: 13px;
    color: var(--muted);
    display:flex;
    align-items:center;
    justify-content: space-between;
    margin-bottom:6px;
    gap:10px;
  }
  .hint{
    font-size: 12px;
    color: var(--muted);
    opacity:.85;
  }
  .field{
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 12px;
    padding: 12px 12px;
    color: var(--text);
    width: 100%;
    outline:none;
  }
  .field:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,207,255,0.15);
  }
  .unit{
    opacity:.8; font-size:12px;
  }

  .actions{
    display:flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 12px;
  }
  button{
    appearance: none;
    border: none;
    border-radius: 12px;
    padding: 12px 16px;
    cursor:pointer;
    color:#0b1020;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    font-weight: 700;
    letter-spacing: .2px;
    box-shadow: var(--shadow);
  }
  button.secondary{
    background: transparent;
    color: var(--text);
    border:1px solid rgba(255,255,255,0.2);
  }

  .results{
    display:flex;
    flex-direction:column;
    gap: 12px;
  }
  .cards{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width:680px){ .cards{grid-template-columns:1fr} }
  .card{
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 14px;
    padding: 16px;
    min-height: 106px;
  }
  .kpi{
    font-size: clamp(22px, 3.6vw, 30px);
    font-weight: 800;
    line-height: 1.15;
  }
  .kpi small{font-weight:600; font-size: 12px; opacity:.85}
  .kpi-label{
    color: var(--muted);
    margin-top: 6px;
    font-size: 13px;
  }
  .note{
    font-size: 12px; color: var(--muted);
  }
  .ok{ color: var(--ok); }
  .warn{ color: var(--warn); }
  .err{ color: var(--err); }

  details{
    background: rgba(255,255,255,0.05);
    border: 1px dashed rgba(255,255,255,0.2);
    padding: 10px 12px;
    border-radius: 12px;
  }
  summary{
    cursor:pointer;
    color:var(--muted);
    font-weight:600;
    margin: -4px 0 6px;
  }

  footer{
    text-align:center;
    padding: 32px 12px 40px;
    color: var(--muted);
    font-weight:600;
  }
  .brand{
    display:inline-block;
    padding: 8px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.18);
  }
</style>
</head>
<body>
  <header>
    <h1>Calculadora Solar &nbsp;‚Üí&nbsp; Carro El√©trico</h1>
    <div class="subtitle">Descubra quanta energia seu sistema fotovoltaico precisa gerar e o tempo para carregar seu EV.</div>
  </header>

  <div class="container">
    <!-- Entrada -->
    <div class="panel">
  <div class="section-title">‚ö° Especifica√ß√µes do Carro</div>
  <div id="carrosContainer"></div>
  <div class="section-title" style="margin-top:16px;">‚òÄÔ∏è Sistema Fotovoltaico</div>
  <div id="placasContainer"></div>
      <div class="actions">
        <button id="calcBtn">Calcular</button>
        <button class="secondary" id="resetBtn">Limpar</button>
      </div>
      <!-- Bot√£o √∫nico para abrir modal de salvar/modelos -->
      <div style="margin-top:18px; display:flex; justify-content:flex-end;">
        <button id="openSaveModalBtn" type="button" style="min-width:120px;">üíæ Salvar / Modelos</button>
      </div>
      <div id="saveModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(11,16,32,0.65); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:var(--card); border-radius:18px; box-shadow:var(--shadow); padding:32px 28px; min-width:340px; max-width:96vw; margin:auto; position:relative;">
          <button type="button" id="closeSaveModalBtn" style="position:absolute; top:16px; right:18px; background:transparent; color:var(--err); font-size:22px; border:none; cursor:pointer;">√ó</button>
          <h3 style="color:var(--accent); margin-top:0; margin-bottom:18px; font-size:20px;">Salvar / Modelos</h3>
          <div style="display:flex; flex-direction:column; gap:22px; max-height:70vh; overflow-y:auto;">
            <div style="display:flex; flex-direction:column; gap:6px;">
              <label for="savedConfigs" style="font-weight:600; color:var(--accent);">Configura√ß√µes</label>
              <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                <input id="configNameInput" class="field" placeholder="Nome da configura√ß√£o" style="flex:1; min-width:160px;">
                <button id="saveConfigModalBtn" type="button">Salvar</button>
              </div>
              <div style="display:flex; gap:6px; align-items:center; margin-top:6px;">
                <select id="savedConfigs" style="flex:1; min-width:160px;"></select>
                <button id="loadConfigBtn" type="button">Carregar</button>
                <button id="deleteConfigBtn" type="button">Excluir</button>
              </div>
            </div>
            <div>
              <label for="savedCarModels">Modelos de Carro:</label>
              <div style="display:flex; gap:6px; align-items:center;">
                <input id="carModelNameInput" class="field" placeholder="Nome do modelo" style="flex:1; min-width:130px;">
                <select id="carSelect" title="Carro alvo"></select>
                <button id="saveCarModelBtn" type="button" title="Salvar modelo do carro selecionado">Salvar</button>
              </div>
              <div style="display:flex; gap:6px; align-items:center; margin-top:6px;">
                <select id="savedCarModels" style="flex:1; min-width:160px;"></select>
                <select id="carSelectApply" title="Aplicar em" style="min-width:90px;"></select>
                <button id="loadCarModelBtn" type="button" title="Aplicar modelo no carro escolhido">Aplicar</button>
              </div>
            </div>
            <div>
              <label for="savedPlacaModels">Modelos de Placa:</label>
              <div style="display:flex; gap:6px; align-items:center;">
                <input id="placaModelNameInput" class="field" placeholder="Nome do modelo" style="flex:1; min-width:130px;">
                <select id="placaSelect" title="Placa alvo"></select>
                <button id="savePlacaModelBtn" type="button" title="Salvar modelo da placa selecionada">Salvar</button>
              </div>
              <div style="display:flex; gap:6px; align-items:center; margin-top:6px;">
                <select id="savedPlacaModels" style="flex:1; min-width:160px;"></select>
                <select id="placaSelectApply" title="Aplicar em" style="min-width:90px;"></select>
                <button id="loadPlacaModelBtn" type="button" title="Aplicar modelo na placa escolhida">Aplicar</button>
              </div>
            </div>
          </div>
        </div>
document.addEventListener('DOMContentLoaded', function(){
  </div>
      <details style="margin-top:12px">
        <summary>Como calculamos?</summary>
        <div class="hint">
          <p><b>Energia na bateria</b>: E_bat = Cap_utiliz√°vel_kWh √ó (SOC_final ‚àí SOC_inicial)</p>
          <p><b>Energia FV necess√°ria</b>: E_PV = E_bat / Œ∑_global</p>
          <p><b>Gera√ß√£o di√°ria</b>: E_dia = kWp √ó PSH √ó PR</p>
          <p><b>Dias necess√°rios</b>: Dias = E_PV / E_dia</p>
          <p><b>Horas de sol pleno</b>: Horas = E_PV / (kWp √ó PR)</p>
          <p><b>Limite te√≥rico por pot√™ncia</b>: t_m√≠n ‚âà E_bat / min(onboard_kW, kWp √ó PR)</p>
        </div>
      </details>
    </div>
    <!-- Resultados -->
    <div class="results">
      <div class="section-title">üìä Resultados</div>
      <div class="cards">
        <div class="card">
          <div class="kpi" id="kpiEbat">‚Äî</div>
          <div class="kpi-label">Energia para a bateria</div>
          <div class="note">Entre SOC inicial e final.</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiEpv">‚Äî</div>
          <div class="kpi-label">Energia FV necess√°ria (rede ‚Üí bateria)</div>
          <div class="note">Considerando a efici√™ncia global.</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiEdia">‚Äî</div>
          <div class="kpi-label">Gera√ß√£o di√°ria estimada</div>
          <div class="note">kWp √ó PSH √ó PR.</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiDias">‚Äî</div>
          <div class="kpi-label">Dias necess√°rios</div>
          <div class="note">M√©dia ‚Äî varia com clima/esta√ß√£o.</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiHoras">‚Äî</div>
          <div class="kpi-label">Horas de sol pleno equivalentes</div>
          <div class="note">Total acumulado necess√°rio.</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiTmin">‚Äî</div>
          <div class="kpi-label">Tempo m√≠nimo te√≥rico</div>
          <div class="note">Limitado por pot√™ncia (irrealista/idealizado).</div>
        </div>
      </div>
      <div id="alerts" style="margin-top:8px; display:none;">
        <div class="note" id="alertText"></div>
      </div>
      <details style="margin-top:4px">
        <summary>Notas & Limita√ß√µes</summary>
        <div class="hint">
          <ul>
            <li>Valores de PR e PSH s√£o m√©dias; clima e esta√ß√£o alteram bastante.</li>
            <li>Perto de 80‚Äì100% de SOC, o BMS reduz a pot√™ncia de carga.</li>
            <li>O tempo m√≠nimo te√≥rico assume pot√™ncia constante e condi√ß√µes ideais.</li>
            <li>Se o sistema for off-grid/DC direto, ajuste a efici√™ncia global conforme o caso.</li>
          </ul>
        </div>
      </details>
    </div>
  </div>

  <footer>
    <span class="brand">IoTEC Lab - UNIVALI</span>
  </footer>
  <footer>
        Desenvolvido por Tiburski, Herick Betin ‚Ä¢ 2025
  </footer>
  
<script>

// Utilit√°rios
function num(v, def=0){
  const n = Number(v);
  return Number.isFinite(n) ? n : def;
}
function clamp(n, a, b){
  return Math.min(Math.max(n, a), b);
}
function fmtKWh(x){
  if (!Number.isFinite(x)) return '‚Äî';
  return x >= 100 ? x.toFixed(0) + ' kWh' : x.toFixed(2) + ' kWh';
}
function fmtKW(x){
  if (!Number.isFinite(x)) return '‚Äî';
  return x.toFixed(2) + ' kW';
}
function fmtH(x){
  if (!Number.isFinite(x)) return '‚Äî';
  return x.toFixed(1) + ' h';
}
function fmtDias(x){
  if (!Number.isFinite(x)) return '‚Äî';
  if (x < 1) return (x*24).toFixed(1) + ' h';
  return x.toFixed(2) + ' dias';
}

// L√≥gica do modal (abrir/fechar) integrada corretamente
function initSaveModal(){
  const openBtn = document.getElementById('openSaveModalBtn');
  const modal = document.getElementById('saveModal');
  const closeBtn = document.getElementById('closeSaveModalBtn');
  if(!openBtn || !modal || !closeBtn) return;
  openBtn.addEventListener('click', ()=>{ modal.style.display='flex'; });
  closeBtn.addEventListener('click', ()=>{ modal.style.display='none'; });
  modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display='none'; });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') modal.style.display='none'; });
}

// Carros din√¢micos
function carroFields(id, values={}){
  return `<div class="card-dyn">
    <div class="card-title">üöó ${values.nome||'' ? values.nome : 'Carro '+(id+1)}</div>
    <button type="button" class="remove-btn" onclick="removerCarro(${id})" title="Remover">√ó</button>
    <div class="grid">
      <div><label>Nome do carro</label><input class="field" id="carroNome${id}" type="text" value="${values.nome||''}" placeholder="Ex: EV1"></div>
      <div><label>Capacidade da bateria <span class="unit">kWh</span></label><input class="field" id="capNominal${id}" type="number" min="1" step="0.1" value="${values.capNominal||60}"></div>
      <div><label>Capacidade utiliz√°vel <span class="unit">%</span></label><input class="field" id="percUtil${id}" type="number" min="50" max="100" step="1" value="${values.percUtil||95}"></div>
      <div><label>SOC inicial <span class="unit">%</span></label><input class="field" id="socIni${id}" type="number" min="0" max="100" step="1" value="${values.socIni||20}"></div>
      <div><label>SOC final <span class="unit">%</span></label><input class="field" id="socFim${id}" type="number" min="1" max="100" step="1" value="${values.socFim||100}"></div>
      <div><label>Efici√™ncia global FV‚Üíbateria <span class="unit">%</span></label><input class="field" id="etaGlobal${id}" type="number" min="60" max="99" step="1" value="${values.etaGlobal||85}"></div>
      <div><label>Pot√™ncia m√°x. do carregador onboard <span class="unit">kW</span></label><input class="field" id="onboardKW${id}" type="number" min="0" step="0.1" value="${values.onboardKW||7.4}"></div>
    </div>
  </div>`;
}
function placaFields(id, values={}){
  return `<div class="card-dyn">
    <div class="card-title">‚òÄÔ∏è ${values.nome||'' ? values.nome : 'Placa '+(id+1)}</div>
    <button type="button" class="remove-btn" onclick="removerPlaca(${id})" title="Remover">√ó</button>
    <div class="grid">
      <div><label>Nome da placa</label><input class="field" id="placaNome${id}" type="text" value="${values.nome||''}" placeholder="Ex: FV1"></div>
      <div>
        <label>Pot√™ncia do array <span class="unit">kWp</span>
          <span style="cursor:pointer;color:var(--accent);font-size:16px;margin-left:6px;" onclick="toggleParrayHelper(${id})" title="Calcular pot√™ncia do array">&#x3f;</span>
        </label>
        <input class="field" id="kWp${id}" type="number" min="0.1" step="0.1" value="${values.kWp||2.0}">
        <div id="parrayHelper${id}" style="display:none;margin-top:8px;background:rgba(124,207,255,0.08);padding:10px;border-radius:10px;">
          <label style="font-size:13px;">Pot√™ncia do m√≥dulo (W)</label>
          <input class="field" id="moduloPot${id}" type="number" min="1" step="1" style="margin-bottom:6px;">
          <label style="font-size:13px;">N¬∫ de m√≥dulos</label>
          <input class="field" id="numModulos${id}" type="number" min="1" step="1" style="margin-bottom:6px;">
          <button type="button" class="secondary" onclick="calcularParray(${id})">Calcular</button>
          <div id="parrayResult${id}" style="margin-top:6px;font-size:13px;color:var(--accent);"></div>
        </div>
      </div>
      <div><label>Performance Ratio (PR) <span class="unit">%</span></label><input class="field" id="pr${id}" type="number" min="50" max="95" step="1" value="${values.pr||75}"></div>
      <div><label>Horas de Sol Pleno (PSH) <span class="unit">h/dia</span></label><input class="field" id="psh${id}" type="number" min="1" step="0.1" value="${values.psh||5}"></div>
      <div><label>Observa√ß√£o</label><input class="field" id="obs${id}" type="text" value="${values.obs||''}" placeholder="Orienta√ß√£o, inclina√ß√£o, sombreamento... (opcional)"></div>
    </div>
  </div>`;
}
// Helper para pot√™ncia do array
function toggleParrayHelper(id){
  const el = document.getElementById('parrayHelper'+id);
  if(el) el.style.display = (el.style.display==='none'||!el.style.display)?'block':'none';
}

function calcularParray(id){
  const potModulo = num(document.getElementById('moduloPot'+id)?.value, 0);
  const numModulos = num(document.getElementById('numModulos'+id)?.value, 0);
  if(potModulo > 0 && numModulos > 0){
    const kWp = (potModulo * numModulos) / 1000;
    document.getElementById('kWp'+id).value = kWp.toFixed(2);
    document.getElementById('parrayResult'+id).textContent = `Pot√™ncia do array: ${kWp.toFixed(2)} kWp`;
  }else{
    document.getElementById('parrayResult'+id).textContent = '';
  }
}

let carros = [{id:0}];
let placas = [{id:0}];
let nextCarroId = 1;
let nextPlacaId = 1;

function renderCarros(){
  const container = document.getElementById('carrosContainer');
  container.innerHTML = carros.map(c=>carroFields(c.id, c)).join('');
  updateSavedCarModels();
}
function renderPlacas(){
  const container = document.getElementById('placasContainer');
  container.innerHTML = placas.map(p=>placaFields(p.id, p)).join('');
  updateSavedPlacaModels();
}
function adicionarCarro(){
  carros.push({id:nextCarroId++});
  renderCarros();
}
function removerCarro(id){
  carros = carros.filter(c=>c.id!==id);
  if(carros.length===0){carros=[{id:nextCarroId++}];}
  renderCarros();
}
function adicionarPlaca(){
  placas.push({id:nextPlacaId++});
  renderPlacas();
}
function removerPlaca(id){
  placas = placas.filter(p=>p.id!==id);
  if(placas.length===0){placas=[{id:nextPlacaId++}];}
  renderPlacas();
}

// Salvar/Carregar configura√ß√µes
function getConfigFromFields(){
  // Carros
  let carrosData = carros.map(c=>({
    id: c.id,
    nome: document.getElementById('carroNome'+c.id)?.value||'',
    capNominal: num(document.getElementById('capNominal'+c.id)?.value, 60),
    percUtil: num(document.getElementById('percUtil'+c.id)?.value, 95),
    socIni: num(document.getElementById('socIni'+c.id)?.value, 20),
    socFim: num(document.getElementById('socFim'+c.id)?.value, 100),
    etaGlobal: num(document.getElementById('etaGlobal'+c.id)?.value, 85),
    onboardKW: num(document.getElementById('onboardKW'+c.id)?.value, 7.4)
  }));
  // Placas
  let placasData = placas.map(p=>({
    id: p.id,
    nome: document.getElementById('placaNome'+p.id)?.value||'',
    kWp: num(document.getElementById('kWp'+p.id)?.value, 2.0),
    pr: num(document.getElementById('pr'+p.id)?.value, 75),
    psh: num(document.getElementById('psh'+p.id)?.value, 5),
    obs: document.getElementById('obs'+p.id)?.value||''
  }));
  return {carros:carrosData, placas:placasData};
}

function saveConfig(){
  const input = document.getElementById('configNameInput');
  const nome = input?.value?.trim() || prompt('Nome para salvar configura√ß√£o:');
  if(!nome) return;
  let configs = JSON.parse(localStorage.getItem('evConfigs')||'{}');
  configs[nome] = getConfigFromFields();
  localStorage.setItem('evConfigs', JSON.stringify(configs));
  updateSavedConfigs();
  alert('Configura√ß√£o salva!');
}
function updateSavedConfigs(){
  let configs = JSON.parse(localStorage.getItem('evConfigs')||'{}');
  const select = document.getElementById('savedConfigs');
  select.innerHTML = Object.keys(configs).map(n=>`<option value="${n}">${n}</option>`).join('');
}
function loadConfig(){
  const select = document.getElementById('savedConfigs');
  const nome = select.value;
  if(!nome) return;
  let configs = JSON.parse(localStorage.getItem('evConfigs')||'{}');
  const conf = configs[nome];
  if(!conf) return;
  carros = conf.carros.map((c,i)=>({...c,id:i}));
  placas = conf.placas.map((p,i)=>({...p,id:i}));
  nextCarroId = carros.length;
  nextPlacaId = placas.length;
  renderCarros();
  renderPlacas();
  updateSavedCarModels();
  updateSavedPlacaModels();
}
function deleteConfig(){
  const select = document.getElementById('savedConfigs');
  const nome = select.value;
  if(!nome) return;
  let configs = JSON.parse(localStorage.getItem('evConfigs')||'{}');
  delete configs[nome];
  localStorage.setItem('evConfigs', JSON.stringify(configs));
  updateSavedConfigs();
}

// Salvar/Carregar modelos de carro
function getCarModelFromFields(id){
  return {
    nome: document.getElementById('carroNome'+id)?.value||'',
    capNominal: num(document.getElementById('capNominal'+id)?.value, 60),
    percUtil: num(document.getElementById('percUtil'+id)?.value, 95),
    socIni: num(document.getElementById('socIni'+id)?.value, 20),
    socFim: num(document.getElementById('socFim'+id)?.value, 100),
    etaGlobal: num(document.getElementById('etaGlobal'+id)?.value, 85),
    onboardKW: num(document.getElementById('onboardKW'+id)?.value, 7.4)
  };
}
function saveCarModel(){
  if(carros.length===0) return;
  const targetSelect = document.getElementById('carSelect');
  const id = Number(targetSelect?.value ?? carros[0].id);
  const nomeInput = document.getElementById('carModelNameInput');
  const nome = nomeInput?.value?.trim();
  if(!nome){ alert('Defina um nome para o modelo de carro.'); return; }
  let models = JSON.parse(localStorage.getItem('carModels')||'{}');
  models[nome] = getCarModelFromFields(id);
  localStorage.setItem('carModels', JSON.stringify(models));
  updateSavedCarModels();
  alert('Modelo de carro salvo!');
}
function updateSavedCarModels(){
  let models = JSON.parse(localStorage.getItem('carModels')||'{}');
  const savedSel = document.getElementById('savedCarModels');
  if(savedSel) savedSel.innerHTML = Object.keys(models).map(n=>`<option value="${n}">${n}</option>`).join('');
  // Atualiza selects de carros
  const carSelect = document.getElementById('carSelect');
  const carSelectApply = document.getElementById('carSelectApply');
  const options = carros.map(c=>`<option value="${c.id}">${document.getElementById('carroNome'+c.id)?.value||'Carro '+(c.id+1)}</option>`).join('');
  if(carSelect) carSelect.innerHTML = options;
  if(carSelectApply) carSelectApply.innerHTML = options;
}
function loadCarModel(){
  const savedSel = document.getElementById('savedCarModels');
  const applySel = document.getElementById('carSelectApply');
  if(!savedSel || !applySel) return;
  const nome = savedSel.value;
  const carId = Number(applySel.value);
  if(!nome || isNaN(carId)) return;
  let models = JSON.parse(localStorage.getItem('carModels')||'{}');
  const model = models[nome];
  if(!model) return;
  document.getElementById('carroNome'+carId).value = model.nome;
  document.getElementById('capNominal'+carId).value = model.capNominal;
  document.getElementById('percUtil'+carId).value = model.percUtil;
  document.getElementById('socIni'+carId).value = model.socIni;
  document.getElementById('socFim'+carId).value = model.socFim;
  document.getElementById('etaGlobal'+carId).value = model.etaGlobal;
  document.getElementById('onboardKW'+carId).value = model.onboardKW;
  alert('Modelo aplicado!');
}

// Salvar/Carregar modelos de placa
function getPlacaModelFromFields(id){
  return {
    nome: document.getElementById('placaNome'+id)?.value||'',
    kWp: num(document.getElementById('kWp'+id)?.value, 2.0),
    pr: num(document.getElementById('pr'+id)?.value, 75),
    psh: num(document.getElementById('psh'+id)?.value, 5),
    obs: document.getElementById('obs'+id)?.value||''
  };
}
function savePlacaModel(){
  if(placas.length===0) return;
  const targetSelect = document.getElementById('placaSelect');
  const id = Number(targetSelect?.value ?? placas[0].id);
  const nomeInput = document.getElementById('placaModelNameInput');
  const nome = nomeInput?.value?.trim();
  if(!nome){ alert('Defina um nome para o modelo de placa.'); return; }
  let models = JSON.parse(localStorage.getItem('placaModels')||'{}');
  models[nome] = getPlacaModelFromFields(id);
  localStorage.setItem('placaModels', JSON.stringify(models));
  updateSavedPlacaModels();
  alert('Modelo de placa salvo!');
}
function updateSavedPlacaModels(){
  let models = JSON.parse(localStorage.getItem('placaModels')||'{}');
  const savedSel = document.getElementById('savedPlacaModels');
  if(savedSel) savedSel.innerHTML = Object.keys(models).map(n=>`<option value="${n}">${n}</option>`).join('');
  const placaSelect = document.getElementById('placaSelect');
  const placaSelectApply = document.getElementById('placaSelectApply');
  const options = placas.map(p=>`<option value="${p.id}">${document.getElementById('placaNome'+p.id)?.value||'Placa '+(p.id+1)}</option>`).join('');
  if(placaSelect) placaSelect.innerHTML = options;
  if(placaSelectApply) placaSelectApply.innerHTML = options;
}
function loadPlacaModel(){
  const savedSel = document.getElementById('savedPlacaModels');
  const applySel = document.getElementById('placaSelectApply');
  if(!savedSel || !applySel) return;
  const nome = savedSel.value;
  const placaId = Number(applySel.value);
  if(!nome || isNaN(placaId)) return;
  let models = JSON.parse(localStorage.getItem('placaModels')||'{}');
  const model = models[nome];
  if(!model) return;
  document.getElementById('placaNome'+placaId).value = model.nome;
  document.getElementById('kWp'+placaId).value = model.kWp;
  document.getElementById('pr'+placaId).value = model.pr;
  document.getElementById('psh'+placaId).value = model.psh;
  document.getElementById('obs'+placaId).value = model.obs;
  alert('Modelo aplicado!');
}

// C√°lculo para m√∫ltiplos carros/placas (ainda exibe s√≥ do primeiro)

function calcular(){
  // Somar energia de todos os carros
  let E_bat_total = 0;
  let E_pv_total = 0;
  let onboardKW_total = 0;
  let etaGlobal_min = 1;
  let alerts = [];
  let nomesCarros = [];
  carros.forEach(c => {
    const capNominal = num(document.getElementById('capNominal'+c.id)?.value, 60);
    const percUtil   = clamp(num(document.getElementById('percUtil'+c.id)?.value, 95), 0, 100) / 100.0;
    const socIni     = clamp(num(document.getElementById('socIni'+c.id)?.value, 20), 0, 100) / 100.0;
    const socFim     = clamp(num(document.getElementById('socFim'+c.id)?.value, 100), 0, 100) / 100.0;
    const etaGlobal  = clamp(num(document.getElementById('etaGlobal'+c.id)?.value, 85), 1, 100) / 100.0;
    const onboardKW  = Math.max(0, num(document.getElementById('onboardKW'+c.id)?.value, 7.4));
    nomesCarros.push(document.getElementById('carroNome'+c.id)?.value||'Carro '+(c.id+1));
    if (socFim <= socIni) alerts.push(`O SOC final do carro ${nomesCarros[nomesCarros.length-1]} deve ser maior que o SOC inicial.`);
    const capUtil_kWh = capNominal * percUtil;
    const deltaSOC    = Math.max(0, socFim - socIni);
    const E_bat       = capUtil_kWh * deltaSOC;
    const E_pv        = E_bat > 0 ? E_bat / etaGlobal : 0;
    E_bat_total += E_bat;
    E_pv_total += E_pv;
    onboardKW_total += onboardKW;
    if (etaGlobal < etaGlobal_min) etaGlobal_min = etaGlobal;
    if (etaGlobal < 0.75) alerts.push(`Efici√™ncia global baixa no carro ${nomesCarros[nomesCarros.length-1]}`);
  });

  // Somar pot√™ncia e gera√ß√£o das placas
  let kWp_total = 0;
  let pr_total = 0;
  let psh_total = 0;
  let nomesPlacas = [];
  placas.forEach(p => {
    const kWp = Math.max(0, num(document.getElementById('kWp'+p.id)?.value, 2.0));
    const pr  = clamp(num(document.getElementById('pr'+p.id)?.value, 75), 1, 100) / 100.0;
    const psh = Math.max(0, num(document.getElementById('psh'+p.id)?.value, 5));
    nomesPlacas.push(document.getElementById('placaNome'+p.id)?.value||'Placa '+(p.id+1));
    if (kWp <= 0) alerts.push(`Defina a pot√™ncia do array (kWp) > 0 para ${nomesPlacas[nomesPlacas.length-1]}.`);
    if (psh <= 0) alerts.push(`Defina as horas de sol pleno (PSH) > 0 para ${nomesPlacas[nomesPlacas.length-1]}.`);
    kWp_total += kWp;
    pr_total += pr;
    psh_total += psh;
  });
  // M√©dia dos PR e PSH
  pr_total = placas.length ? pr_total/placas.length : 0;
  psh_total = placas.length ? psh_total/placas.length : 0;

  // C√°lculos totais
  const E_dia = kWp_total * psh_total * pr_total;
  const dias = (E_dia > 0) ? (E_pv_total / E_dia) : Infinity;
  const horasSol = (kWp_total*pr_total > 0) ? (E_pv_total / (kWp_total * pr_total)) : Infinity;
  const P_pico_FV = kWp_total * pr_total;
  const P_lim = Math.max(0, Math.min(onboardKW_total || Infinity, P_pico_FV || Infinity));
  const t_min = (P_lim > 0) ? (E_bat_total / P_lim) : Infinity;

  if (P_pico_FV < 1.0) alerts.push("Pot√™ncia de pico FV baixa; carregamento ser√° bem lento.");
  if (!Number.isFinite(dias) || !Number.isFinite(horasSol)) alerts.push("Verifique os campos: h√° valores inv√°lidos.");

  // Exibir KPIs totais
  document.getElementById('kpiEbat').innerHTML  = `<span class="ok">${fmtKWh(E_bat_total)}</span>`;
  document.getElementById('kpiEpv').innerHTML   = fmtKWh(E_pv_total);
  document.getElementById('kpiEdia').innerHTML  = fmtKWh(E_dia) + ` <small>(por dia)</small>`;
  document.getElementById('kpiDias').innerHTML  = fmtDias(dias);
  document.getElementById('kpiHoras').innerHTML = fmtH(horasSol);
  document.getElementById('kpiTmin').innerHTML  = Number.isFinite(t_min) ? fmtH(t_min) : '‚Äî';

  const alertBox = document.getElementById('alerts');
  const alertText = document.getElementById('alertText');
  if (alerts.length){
    alertBox.style.display = 'block';
    alertText.innerHTML = '‚ö†Ô∏è ' + alerts.join('<br>');
  }else{
    alertBox.style.display = 'none';
    alertText.innerHTML = '';
  }
}

function limpar(){
  carros = [{id:0}];
  placas = [{id:0}];
  nextCarroId = 1;
  nextPlacaId = 1;
  renderCarros();
  renderPlacas();
  // limpa resultados
  ['kpiEbat','kpiEpv','kpiEdia','kpiDias','kpiHoras','kpiTmin'].forEach(id=>{
    document.getElementById(id).textContent = '‚Äî';
  });
  document.getElementById('alerts').style.display = 'none';
  document.getElementById('alertText').textContent = '';
}

// Eventos
document.getElementById('calcBtn').addEventListener('click', calcular);
document.getElementById('resetBtn').addEventListener('click', limpar);
document.getElementById('saveConfigModalBtn').addEventListener('click', saveConfig);
document.getElementById('loadConfigBtn').addEventListener('click', loadConfig);
document.getElementById('deleteConfigBtn').addEventListener('click', deleteConfig);
document.getElementById('saveCarModelBtn').addEventListener('click', saveCarModel);
document.getElementById('loadCarModelBtn').addEventListener('click', loadCarModel);
document.getElementById('savePlacaModelBtn').addEventListener('click', savePlacaModel);
document.getElementById('loadPlacaModelBtn').addEventListener('click', loadPlacaModel);

// Inicializa√ß√£o
renderCarros(); // j√° cria Carro 1
renderPlacas(); // j√° cria Placa 1
updateSavedConfigs();
updateSavedCarModels();
updateSavedPlacaModels();
initSaveModal();
calcular();
</script>
</body>
</html>
