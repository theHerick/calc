<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Locais BLE</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    .device-btn { display: block; margin: 5px auto; }
  </style>
</head>
<body>
  <h1>Dispositivos LocSound</h1>
  <button onclick="escanear()">‚ûï Adicionar Dispositivo</button>
  <div id="dispositivos"></div>
  <button onclick="desconectarTodos()">‚ùå Desconectar de Todos</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBD6yjWumcmaugkoKlStcsKWcMXwTK2DLc",
      authDomain: "locsound-b4f27.firebaseapp.com",
      databaseURL: "https://locsound-b4f27-default-rtdb.firebaseio.com",
      projectId: "locsound-b4f27",
      storageBucket: "locsound-b4f27.appspot.com",
      messagingSenderId: "592998466073",
      appId: "1:592998466073:web:4c47763505096354fd6088",
      measurementId: "G-Q8NEQQVS1J"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let conexoes = {};

    async function escanear() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: []
        });

        const nome = device.name || device.id;
        await db.ref("locais/" + nome).set({
          name: device.name || "Sem nome",
          id: device.id
        });

        carregarDispositivos();
      } catch (e) {
        alert("Erro ao escanear: " + e);
      }
    }

    async function carregarDispositivos() {
      const container = document.getElementById("dispositivos");
      container.innerHTML = "";

      const snap = await db.ref("locais").once("value");
      const locais = snap.val();

      if (!locais) {
        container.innerHTML = "<p>Nenhum dispositivo salvo.</p>";
        return;
      }

      Object.entries(locais).forEach(([chave, dado]) => {
        const btn = document.createElement("button");
        btn.textContent = "üîå Conectar: " + dado.name;
        btn.className = "device-btn";
        btn.onclick = () => conectar(dado.id, dado.name);
        container.appendChild(btn);
      });
    }

    async function conectar(id, nome) {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: nome }]
        });

        const server = await device.gatt.connect();
        conexoes[nome] = server;

        alert("Conectado a: " + nome);
      } catch (e) {
        alert("Erro ao conectar: " + e);
      }
    }

    function desconectarTodos() {
      for (let nome in conexoes) {
        conexoes[nome].disconnect();
      }
      conexoes = {};
      alert("Desconectado de todos");
    }

    carregarDispositivos();
  </script>
</body>
</html>
