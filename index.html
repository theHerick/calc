<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>LocSound BLE + Firebase</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; background: #f5f5f5; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    .device-btn { display: block; margin: 5px auto; background: #d9f0ff; border-radius: 8px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>LocSound - Scanner BLE</h1>
  <button onclick="scanBLE()">üîç Escanear Dispositivos</button>
  <div id="deviceList"></div>
  <h3>Dispositivos salvos</h3>
  <div id="savedList"></div>
  <button onclick="disconnectAll()">üîå Desconectar de Todos</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBD6yjWumcmaugkoKlStcsKWcMXwTK2DLc",
      authDomain: "locsound-b4f27.firebaseapp.com",
      databaseURL: "https://locsound-b4f27-default-rtdb.firebaseio.com",
      projectId: "locsound-b4f27",
      storageBucket: "locsound-b4f27.appspot.com",
      messagingSenderId: "592998466073",
      appId: "1:592998466073:web:4c47763505096354fd6088",
      measurementId: "G-Q8NEQQVS1J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userId = "herick"; // pode usar nome de conta no futuro

    let connectedDevices = [];

    function saveDeviceToFirebase(name, id) {
      set(ref(db, `usuarios/${userId}/dispositivos/${id}`), {
        name: name,
        id: id
      });
    }

    async function scanBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true
        });
        connectedDevices.push(device);
        saveDeviceToFirebase(device.name || "Sem Nome", device.id);
        alert(`Dispositivo encontrado: ${device.name || "Sem Nome"}`);
      } catch (error) {
        console.error("Erro ao escanear dispositivo:", error);
      }
    }

    function renderSavedDevices() {
      const savedList = document.getElementById("savedList");
      savedList.innerHTML = "Carregando...";

      const userRef = ref(db, `usuarios/${userId}/dispositivos`);
      onValue(userRef, (snapshot) => {
        savedList.innerHTML = "";
        const data = snapshot.val();
        if (data) {
          Object.values(data).forEach((dev) => {
            const btn = document.createElement("button");
            btn.textContent = `üîó ${dev.name}`;
            btn.className = "device-btn";
            btn.onclick = () => reconnectDevice(); // reconectar
            savedList.appendChild(btn);
          });
        } else {
          savedList.innerHTML = "Nenhum salvo ainda.";
        }
      });
    }

    function disconnectAll() {
      connectedDevices.forEach(d => {
        if (d.gatt && d.gatt.connected) d.gatt.disconnect();
      });
      connectedDevices = [];
      alert("Todos os dispositivos foram desconectados.");
    }

    async function reconnectDevice() {
      try {
        const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
        connectedDevices.push(device);
        alert(`Reconectado: ${device.name || "Sem Nome"}`);
      } catch (error) {
        console.error("Erro ao reconectar:", error);
      }
    }

    renderSavedDevices();
  </script>
</body>
</html>
