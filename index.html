<script>
  const scanBtn = document.getElementById('scanBtn');
  const status = document.getElementById('status');
  const deviceContainer = document.getElementById('deviceContainer');
  const dispositivos = new Map(); // nome => device
  let voz = window.speechSynthesis;

  function falar(texto) {
    const msg = new SpeechSynthesisUtterance(texto);
    msg.lang = 'pt-BR';
    msg.rate = 1.1;
    msg.pitch = 1;
    voz.cancel();
    voz.speak(msg);
  }

  function salvarDispositivosLocalmente() {
    const nomes = Array.from(dispositivos.keys());
    localStorage.setItem('dispositivosLocSound', JSON.stringify(nomes));
  }

  function carregarDispositivosSalvos() {
    const salvos = JSON.parse(localStorage.getItem('dispositivosLocSound')) || [];
    salvos.forEach(nome => {
      dispositivos.set(nome, { name: nome, gatt: {} }); // Placeholder
    });
    atualizarListaDispositivos();
  }

  function ordenarDispositivos(devices) {
    return devices.sort((a, b) => {
      const aIsLocSound = a.name && a.name.startsWith('LocSound');
      const bIsLocSound = b.name && b.name.startsWith('LocSound');
      if (aIsLocSound && !bIsLocSound) return -1;
      if (!aIsLocSound && bIsLocSound) return 1;
      return a.name.localeCompare(b.name);
    });
  }

  scanBtn.addEventListener('click', async () => {
    if (!navigator.bluetooth) {
      status.textContent = "âŒ Seu navegador nÃ£o suporta Web Bluetooth.";
      falar("Navegador nÃ£o suporta Bluetooth.");
      return;
    }

    try {
      status.textContent = "ðŸ” Escaneando dispositivos...";
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'LocSound' }],
        optionalServices: ['battery_service', 'device_information']
      });

      if (!device.name) {
        status.textContent = "âš ï¸ Dispositivo sem nome ignorado.";
        falar("Dispositivo sem nome ignorado.");
        return;
      }

      if (!dispositivos.has(device.name)) {
        dispositivos.set(device.name, device);
        salvarDispositivosLocalmente();
        atualizarListaDispositivos();
        status.textContent = `ðŸ“¡ Dispositivo adicionado: ${device.name}`;
        falar(`Dispositivo ${device.name} adicionado`);
      } else {
        status.textContent = `â„¹ï¸ Dispositivo ${device.name} jÃ¡ estÃ¡ listado.`;
        falar(`Dispositivo ${device.name} jÃ¡ listado`);
      }
    } catch (error) {
      status.textContent = `âŒ Erro: ${error.message}`;
      falar(`Erro: ${error.message}`);
    }
  });

  function criarBotaoDispositivo(nome, device) {
    const deviceItem = document.createElement('div');
    deviceItem.className = 'device-item';

    const btn = document.createElement('button');
    btn.className = 'device-btn';
    btn.textContent = `LocSound - ${nome}`;

    const btnReconnect = document.createElement('button');
    btnReconnect.className = 'reconnect-btn';
    btnReconnect.textContent = `ðŸ”„ Reconectar - ${nome}`;

    let pressTimer;
    let conectado = false;
    let server = null;

    btn.addEventListener('click', async () => {
      falar(`Dispositivo ${nome}`);
    });

    btn.addEventListener('mousedown', () => {
      pressTimer = setTimeout(async () => {
        try {
          status.textContent = `ðŸ”Œ Conectando a ${nome}...`;
          falar(`Conectando a ${nome}`);
          if (device.gatt && device.gatt.connect) {
            server = await device.gatt.connect();
            conectado = true;
            status.textContent = `âœ… Conectado a ${nome}`;
            falar(`Conectado a ${nome}`);
            btn.style.backgroundColor = '#4CAF50';
          } else {
            throw new Error("Dispositivo nÃ£o pode ser reconectado automaticamente. Reescaneie.");
          }
        } catch (error) {
          status.textContent = `âŒ Erro ao conectar a ${nome}: ${error.message}`;
          falar(`Erro ao conectar em ${nome}`);
        }
      }, 800);
    });

    btn.addEventListener('mouseup', () => clearTimeout(pressTimer));
    btn.addEventListener('mouseleave', () => clearTimeout(pressTimer));

    btnReconnect.addEventListener('click', async () => {
      try {
        status.textContent = `ðŸ” Reconectando a ${nome}...`;
        falar(`Reconectando a ${nome}`);
        if (device.gatt && device.gatt.connected) {
          device.gatt.disconnect();
        }
        server = await device.gatt.connect();
        conectado = true;
        status.textContent = `âœ… Reconectado a ${nome}`;
        falar(`Reconectado a ${nome}`);
        btn.style.backgroundColor = '#4CAF50';
      } catch (error) {
        status.textContent = `âŒ Falha ao reconectar: ${error.message}`;
        falar(`Erro ao reconectar em ${nome}`);
      }
    });

    deviceItem.appendChild(btn);
    deviceItem.appendChild(btnReconnect);
    return deviceItem;
  }

  function atualizarListaDispositivos() {
    deviceContainer.innerHTML = '';
    const dispositivosOrdenados = Array.from(dispositivos.entries()).sort((a, b) => {
      const aIsLocSound = a[0].startsWith('LocSound');
      const bIsLocSound = b[0].startsWith('LocSound');
      if (aIsLocSound && !bIsLocSound) return -1;
      if (!aIsLocSound && bIsLocSound) return 1;
      return a[0].localeCompare(b[0]);
    });

    for (const [nome, device] of dispositivosOrdenados) {
      const item = criarBotaoDispositivo(nome, device);
      deviceContainer.appendChild(item);
    }
  }

  // Carrega os dispositivos salvos ao abrir
  window.addEventListener('load', carregarDispositivosSalvos);
</script>
