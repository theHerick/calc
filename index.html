<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>LocSound BLE com Firebase</title>
  <script type="module">
    // Importa os m√≥dulos do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBD6yjWumcmaugkoKlStcsKWcMXwTK2DLc",
      authDomain: "locsound-b4f27.firebaseapp.com",
      databaseURL: "https://locsound-b4f27-default-rtdb.firebaseio.com",
      projectId: "locsound-b4f27",
      storageBucket: "locsound-b4f27.firebasestorage.app",
      messagingSenderId: "592998466073",
      appId: "1:592998466073:web:4c47763505096354fd6088",
      measurementId: "G-Q8NEQQVS1J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let usuario = null;

    window.onload = () => {
      document.getElementById('btnLogin').onclick = () => {
        const nome = document.getElementById('inputUsuario').value.trim();
        if (!nome) {
          alert('Digite seu nome de usu√°rio');
          return;
        }
        usuario = nome;
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('appDiv').style.display = 'block';
        carregarDispositivosFirebase();
      };

      document.getElementById('btnScan').onclick = scanDispositivo;
    };

    async function scanDispositivo() {
      if (!usuario) {
        alert('Fa√ßa login primeiro');
        return;
      }
      if (!navigator.bluetooth) {
        alert('Seu navegador n√£o suporta Web Bluetooth');
        return;
      }

      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'LocSound' }],
          optionalServices: ['battery_service']
        });

        // Salvar no Firebase
        const dispositivosRef = ref(db, `usuarios/${usuario}/dispositivos`);
        await push(dispositivosRef, {
          nome: device.name || 'Sem nome',
          id: device.id,
          conectadoEm: Date.now()
        });

        alert(`Dispositivo ${device.name} salvo com sucesso!`);
        carregarDispositivosFirebase();

      } catch (e) {
        alert('Erro ao escanear dispositivo: ' + e.message);
      }
    }

    function carregarDispositivosFirebase() {
      const dispositivosRef = ref(db, `usuarios/${usuario}/dispositivos`);
      const lista = document.getElementById('listaDispositivos');
      lista.innerHTML = 'Carregando...';

      onValue(dispositivosRef, (snapshot) => {
        const dados = snapshot.val();
        lista.innerHTML = '';
        if (!dados) {
          lista.innerHTML = '<p>Nenhum dispositivo salvo.</p>';
          return;
        }
        Object.entries(dados).forEach(([key, valor]) => {
          const div = document.createElement('div');
          div.textContent = `${valor.nome} (ID: ${valor.id}) - conectado em: ${new Date(valor.conectadoEm).toLocaleString()}`;
          lista.appendChild(div);
        });
      }, {
        onlyOnce: false
      });
    }
  </script>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin:auto;">
  <h2>LocSound BLE com Firebase</h2>

  <div id="loginDiv">
    <input type="text" id="inputUsuario" placeholder="Digite seu nome" style="padding: 8px; width: 80%;" />
    <button id="btnLogin" style="padding: 10px;">Login</button>
  </div>

  <div id="appDiv" style="display:none;">
    <button id="btnScan" style="padding: 15px; width: 100%; margin-top: 10px;">üîç Scanear Dispositivo LocSound</button>
    <h3>Dispositivos Salvos</h3>
    <div id="listaDispositivos" style="border: 1px solid #ccc; padding: 10px; min-height: 100px;"></div>
  </div>
</body>
</html>
